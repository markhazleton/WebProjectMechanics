# Codebase Audit Report

## Audit Metadata

- **Audit Date**: 2026-02-16 00:43:39 UTC
- **Scope**: full
- **Auditor**: speckit.site-audit
- **Constitution Version**: 1.0.0
- **Repository**: WebProjectMechanics

## Executive Summary

### Compliance Score

| Category | Score | Status |
|----------|-------|--------|
| Constitution Compliance | 58% | ‚ö†Ô∏è PARTIAL |
| Security | 40% | ‚ùå FAIL |
| Code Quality | 65% | ‚ö†Ô∏è PARTIAL |
| Test Coverage | 0% | ‚ùå FAIL |
| Documentation | 55% | ‚ö†Ô∏è PARTIAL |
| Dependencies | 70% | ‚ö†Ô∏è PARTIAL |

**Overall Health**: CRITICAL ISSUES

### Issue Summary

| Severity | Count |
|----------|-------|
| üî¥ CRITICAL | 3 |
| üü† HIGH | 8 |
| üü° MEDIUM | 11 |
| üîµ LOW | 6 |

## Constitution Compliance

### Principle Compliance Matrix

| Principle | Status | Violations | Key Issues |
|-----------|--------|------------|------------|
| I. Interface-First Architecture | ‚ö†Ô∏è PARTIAL | 23 | RssToolkit has ~23 public classes with no interface contracts |
| II. Language Standardization | ‚úÖ PASS | 0 | Mixed VB.NET/C# but no new VB.NET code detected |
| III. .NET Framework Version Lock | ‚úÖ PASS | 0 | All 7 projects target .NET 4.8 consistently |
| IV. XML Documentation | ‚ö†Ô∏è PARTIAL | 4 | RssToolkit missing doc generation config; RemoveWWW has gaps |
| V. Feature-Based Directory Org | ‚ö†Ô∏è PARTIAL | 3 | Centralized Interfaces/ folder; catch-all Utility/ directory |
| VI. Input Validation | ‚ùå FAIL | 7+ | Systemic SQL injection risk via string-formatted queries |
| Strongly-Typed Property Access | ‚úÖ PASS | 0 | No inappropriate public fields found |
| NuGet Package Management | ‚úÖ PASS | 0 | All dependencies managed via NuGet with packages.config |

### Detailed Violations

| ID | Principle | File:Line | Issue | Severity | Recommendation |
|----|-----------|-----------|-------|----------|----------------|
| INTF1 | I. Interface-First | RssToolkit/Rss/RssDocument.cs | `RssDocument` class has no interface contract | MEDIUM | Create `IRssDocument` interface |
| INTF2 | I. Interface-First | RssToolkit/Rss/RssItem.cs | `RssItem` class has no interface contract | MEDIUM | Create `IRssItem` interface |
| INTF3 | I. Interface-First | RssToolkit/Rss/RssChannel.cs | `RssChannel` class has no interface contract | MEDIUM | Create `IRssChannel` interface |
| INTF4 | I. Interface-First | RssToolkit/Rss/DownloadManager.cs | `DownloadManager` class has no interface contract | MEDIUM | Create `IDownloadManager` interface |
| INTF5 | I. Interface-First | RssToolkit/Rss/RssAggregator.cs | `RssAggregator` class has no interface contract | MEDIUM | Create `IRssAggregator` interface |
| INTF6 | I. Interface-First | RssToolkit/Opml/OpmlDocument.cs | `OpmlDocument` class has no interface contract | LOW | Create `IOpmlDocument` interface |
| DOC1 | IV. XML Documentation | RssToolkit/RssToolkit.csproj | No `<DocumentationFile>` configured in project | HIGH | Add `<DocumentationFile>` to Debug and Release |
| DOC2 | IV. XML Documentation | RemoveWWW/ApplicationHttpModule.cs:8 | No `/// <summary>` on `ApplicationHttpModule` class | MEDIUM | Add class-level XML documentation |
| DOC3 | IV. XML Documentation | RemoveWWW/ApplicationHttpModule.cs:20 | No `/// <summary>` on `Init()` method | MEDIUM | Add method-level XML documentation |
| DOC4 | IV. XML Documentation | RemoveWWW/RemoveWWW.csproj | `NOWARN>1591` suppresses missing XML doc warnings | LOW | Remove suppression to surface missing docs |
| ORG1 | V. Feature-Based Org | WebProjectMechanics/Interfaces/ | 15 interface files in centralized folder | MEDIUM | Move interfaces to their feature directories |
| ORG2 | V. Feature-Based Org | WebProjectMechanics/Utility/ | 22+ files at root level ‚Äî catch-all directory | LOW | Refactor into named sub-feature directories |
| ORG3 | V. Feature-Based Org | WebProjectMechanics/SiteTemplate.vb | Root-level file outside any feature directory | LOW | Move to a `SiteTemplate/` feature directory |

## Security Findings

### Vulnerability Summary

| Type | Count | Severity |
|------|-------|----------|
| SQL Injection (String Concatenation) | 7+ | CRITICAL |
| Insecure Patterns (eval/exec) | 4 | HIGH |
| Legacy Request Validation | 1 | MEDIUM |
| Hardcoded Secrets | 0 | ‚Äî |

### Security Checklist

- [x] No hardcoded secrets or credentials
- [ ] ‚ùå Input validation present where needed ‚Äî SQL injection vectors exist
- [ ] ‚ùå No SQL injection vulnerabilities ‚Äî string-formatted SQL throughout VB data layer
- [x] No XSS vulnerabilities (ASP.NET default encoding active)
- [ ] ‚ö†Ô∏è Dependencies free of known vulnerabilities ‚Äî requires `pip-audit`/`npm audit` equivalent
- [ ] ‚ùå Secure configuration practices ‚Äî legacy `requestValidationMode="2.0"` active

### Detailed Security Issues

| ID | File:Line | Issue | Severity | Recommendation |
|----|-----------|-------|----------|----------------|
| SEC1 | WebProjectMechanics/Utility/Modules/UtilityDB.vb:73-140 | `wpm_GetDataTable`, `wpm_RunInsertSQL`, `wpm_RunUpdateSQL`, `wpm_RunDeleteSQL` accept raw SQL strings and execute them via `OleDbCommand` without parameterization | CRITICAL | Refactor all data access methods to use parameterized queries exclusively |
| SEC2 | WebProjectMechanics/Article/Article.vb:232 | `wpm_RunDeleteSQL(String.Format("Delete From Article where ArticleID={0}", ArticleID))` ‚Äî SQL built from string formatting | CRITICAL | Use parameterized query: `DELETE FROM Article WHERE ArticleID=@ArticleID` |
| SEC3 | WebProjectMechanics/Utility/Modules/LocationBuildHTML.vb:91 | `String.Format(" UPDATE SiteCategory SET CategoryKeywords = '{0}'...")` ‚Äî **string values directly interpolated** into SQL | CRITICAL | Use `SqlParameter` for all string values in SQL |
| SEC4 | WebProjectMechanics/SiteTemplate.vb:63 | `String.Format("SELECT ... WHERE SiteTemplate.TemplatePrefix='{0}'; ", SiteTemplatePrefix)` ‚Äî string value in WHERE clause | HIGH | Use parameterized query with `@SiteTemplatePrefix` parameter |
| SEC5 | WebProjectMechanics/Article/ArticleList.vb:48 | `String.Format("SELECT ... CompanyID={0} ", CompanyID)` ‚Äî SQL from string format | HIGH | Use parameterized query |
| SEC6 | WebProjectMechanics/Part/Part.vb:42 | `"DELETE FROM [Link] WHERE [ID] =" & PartID` ‚Äî SQL string concatenation | HIGH | Use parameterized query |
| SEC7 | WebProjectMechanics/Part/PartDirectory.vb:62 | `String.Format("DELETE FROM Link WHERE ID={0}...")` ‚Äî SQL from format string | HIGH | Use parameterized query |
| SEC8 | website/runtime/catalog/lightbox/js/lightbox.js:485 | `eval()` usage in JavaScript | MEDIUM | Replace with safer JSON parsing or explicit function calls |
| SEC9 | website/runtime/catalog/lightbox/js/prototype.js:700-706 | Multiple `eval()` calls in Prototype.js library | MEDIUM | Replace with modern JSON.parse or update library |
| SEC10 | website/admin/js/plugins/flot/jquery.flot.js:31 | `exec()` usage in Flot charting library | LOW | Third-party library ‚Äî accept risk or update to latest version |
| SEC11 | website/Web.config:17 | `requestValidationMode="2.0"` ‚Äî uses less restrictive legacy ASP.NET request validation | MEDIUM | Evaluate upgrading to `requestValidationMode="4.5"` for stronger XSS protection |

**Positive patterns noted:**
- `ApplicationMembershipProvider.vb` uses stored procedures with `SqlParameter` (line 244-247) ‚Äî correct pattern
- `LocationImage.vb` uses parameterized INSERT with `@CompanyID`, `@ImageName` (line 73) ‚Äî correct pattern
- `UtilityDB.vb` has helper methods `wpm_AddParameterStringValue` and `wpm_AddParameterValue` for parameterized queries ‚Äî shows awareness of the issue, but not uniformly applied

## Package/Dependency Analysis

### Package Manager: NuGet (packages.config)

#### Dependency Summary

| Metric | Value |
|--------|-------|
| Total Packages (website) | 22 |
| Total Packages (wpmMineralCollection) | 17 |
| Direct Dependencies | 22 |
| Transitive Dependencies | ~10 (System.* support packages) |
| Outdated | Unknown (manual check needed) |
| Vulnerable | Unknown (no automated scanner) |
| Potentially Unused | 1 |

#### Package Usage Analysis

| Package | Current | Used? | Notes |
|---------|---------|-------|-------|
| EntityFramework | 6.5.1 | ‚úÖ Yes | Core ORM, config in Web.config |
| ImageResizer | 4.2.8 | ‚ö†Ô∏è Partial | Imported in 4 files; actual usage code is partially commented out |
| Microsoft.AspNet.TelemetryCorrelation | 1.0.8 | ‚úÖ Yes | Runtime HTTP module via Web.config |
| Newtonsoft.Json | 13.0.4 | ‚úÖ Yes | Standard JSON library |
| System.Data.SQLite (5 packages) | Mixed | ‚ö†Ô∏è Config-only in website | Direct code usage only in wpmMineralCollection project |
| System.Text.Json | 9.0.9 | ‚úÖ Yes | Modern JSON support |
| Microsoft.Configuration.ConfigurationBuilders | 3.0.0 | ‚úÖ Yes | Config builder framework |

#### Potentially Unused Dependencies

| Package | Declared In | Notes |
|---------|-------------|-------|
| ImageResizer 4.2.8 | website/packages.config | Imported in 4 files but actual `ImageResizer.Instructions` calls are mostly commented out |
| System.Data.SQLite packages (5) | website/packages.config | No direct SQLite code in website ‚Äî exists to support wpmMineralCollection runtime |

## Code Quality Analysis

### Metrics Overview

| Metric | Value | Threshold | Status |
|--------|-------|-----------|--------|
| Total Source Files | 113 | ‚Äî | ‚Äî |
| Total Lines of Code | 42,058 | ‚Äî | ‚Äî |
| Average Lines per File | 372 | <300 | ‚ö†Ô∏è HIGH |
| Max Lines per File | 13,976 | <500 | ‚ùå FAIL |
| Files >500 Lines | 15 | 0 | ‚ùå FAIL |
| TODO/FIXME/HACK/BUG Comments | 33 | ‚Äî | ‚ö†Ô∏è ATTENTION |
| Deep Nesting Occurrences | 0 | 0 | ‚úÖ PASS |
| Test Files | 0 | >0 | ‚ùå FAIL |

### Lines by Language

| Language | Lines | Files | Avg Lines/File |
|----------|-------|-------|----------------|
| C# | 9,717 | 68 | 143 |
| JavaScript | 32,257 | 43 | 750 |
| PHP | 84 | 2 | 42 |

### Files Requiring Attention

| File | Issue | Metric | Recommendation |
|------|-------|--------|----------------|
| website/admin/js/plugins/dataTables/jquery.dataTables.js | Excessive length | 13,976 lines | Replace with CDN reference or minified bundle |
| website/admin/js/plugins/flot/jquery.flot.js | Excessive length | 2,364 lines | Replace with CDN or update to maintained version |
| LumenWorks.Framework.IO/Csv/CsvReader.cs | Excessive length | 2,059 lines | Consider splitting parsing, validation, and I/O |
| website/runtime/catalog/lightbox/js/prototype.js | Excessive length | 1,496 lines | Obsolete library ‚Äî remove if not in use |
| website/admin/js/plugins/morris/morris.js | Excessive length | 1,752 lines | Third-party library ‚Äî use CDN or bundled version |

### Quality Issues

| ID | Category | File:Line | Issue | Severity |
|----|----------|-----------|-------|----------|
| QUAL1 | Complexity | LumenWorks.Framework.IO/Csv/CsvReader.cs | File exceeds 2,000 lines ‚Äî single class with all parsing logic | MEDIUM |
| QUAL2 | Obsolescence | website/runtime/youtube/ | Entire directory contains Flash-era code (.swf, Flash embedding) | HIGH |
| QUAL3 | Obsolescence | website/sites/ProjectMechanics/facebook/ | Contains Flash .swf files and PHP ‚Äî zero references anywhere | HIGH |
| QUAL4 | Commented Code | website/admin/gallery/ListImages.aspx.vb | ImageResizer usage commented out | LOW |
| QUAL5 | Legacy Config | website/Web.config | `requestValidationMode="2.0"` ‚Äî pre-4.5 validation | MEDIUM |

## Test Coverage Analysis

### Coverage Summary

| Category | Files | With Tests | Coverage |
|----------|-------|------------|----------|
| Source Files (C#) | 68 | 0 | 0% |
| Source Files (VB.NET) | ~265 | 0 | 0% |
| Critical Paths | Multiple | 0 | 0% |

### Untested Files

| File | Importance | Recommendation |
|------|------------|----------------|
| WebProjectMechanics/Utility/Modules/UtilityDB.vb | CRITICAL | Data access layer ‚Äî add integration tests |
| WebProjectMechanics/Article/Article.vb | HIGH | Core domain entity ‚Äî add unit tests |
| LumenWorks.Framework.IO/Csv/CsvReader.cs | HIGH | CSV parsing ‚Äî add unit tests for edge cases |
| RssToolkit/Rss/RssDocument.cs | MEDIUM | RSS parsing ‚Äî add parsing tests |
| RemoveWWW/ApplicationHttpModule.cs | MEDIUM | URL rewriting module ‚Äî add behavior tests |

**Note:** The constitution does not have a formal testing principle, but the lack of any test files is a significant quality concern.

## Documentation Status

### Documentation Coverage

| Type | Present | Quality |
|------|---------|---------|
| README.md | ‚úÖ | Adequate |
| API Documentation | ‚ö†Ô∏è | Incomplete ‚Äî RssToolkit has no doc generation |
| Code Comments (C#) | ‚ö†Ô∏è | LumenWorks excellent; RssToolkit/RemoveWWW partial |
| Code Comments (VB.NET) | ‚ö†Ô∏è | Variable quality |
| Inline Docstrings | ‚ö†Ô∏è | Partial across codebase |

### Projects Without Documentation Generation

| Project | Issue | Priority |
|---------|-------|----------|
| RssToolkit/RssToolkit.csproj | No `<DocumentationFile>` element in any build configuration | HIGH |
| LumenWorks.Framework.IO.csproj | `<DocumentationFile>` only in Release, missing from Debug | LOW |

### Missing Documentation (C# Public Members)

| Item | Location | Priority |
|------|----------|----------|
| Class: `ApplicationHttpModule` | RemoveWWW/ApplicationHttpModule.cs:8 | MEDIUM |
| Method: `Init()` | RemoveWWW/ApplicationHttpModule.cs:20 | MEDIUM |
| Method: `Dispose()` | RemoveWWW/ApplicationHttpModule.cs:78 | LOW |
| Property: `ModuleName` | RemoveWWW/ApplicationHttpModule.cs:10 | LOW |

## Unused Code Analysis

### Potentially Unused Items

| Type | Item | Location | Confidence |
|------|------|----------|------------|
| File | `test.aspx` | website/test.aspx | HIGH ‚Äî Hardcoded 2015 cricket HTML; no functional value |
| File | `ErrorCheck.aspx` | website/ErrorCheck.aspx | HIGH ‚Äî Dev-only error testing page |
| File | `GenericErrorPage.aspx` | website/GenericErrorPage.aspx | HIGH ‚Äî Only referenced from ErrorCheck.aspx |
| File | `HttpErrorPage.aspx` | website/HttpErrorPage.aspx | HIGH ‚Äî Only referenced from ErrorCheck.aspx |
| File | `DefaultRedirectErrorPage.aspx` | website/DefaultRedirectErrorPage.aspx | HIGH ‚Äî Only referenced from ErrorCheck.aspx |
| File | `Http404ErrorPage.aspx` | website/Http404ErrorPage.aspx | MEDIUM ‚Äî Not wired in Web.config; 404 uses 404.ashx |
| Directory | `runtime/youtube/` | website/runtime/youtube/ | HIGH ‚Äî Obsolete Flash content; zero external references |
| Directory | `sites/ProjectMechanics/facebook/` | website/sites/ProjectMechanics/facebook/ | HIGH ‚Äî Zero references anywhere in codebase |
| Package | ImageResizer 4.2.8 | website/packages.config | MEDIUM ‚Äî Imported but usage code mostly commented out |

### Dead Technology

| Technology | Locations | Issue |
|------------|-----------|-------|
| Adobe Flash (.swf) | runtime/youtube/, sites/ProjectMechanics/facebook/ | Flash EOL December 2020 ‚Äî all content non-functional |
| PHP | runtime/youtube/index.php, sites/ProjectMechanics/facebook/form.php | PHP files in ASP.NET project ‚Äî likely leftover from a different platform |

## Duplicate Code Analysis

### Duplicate Blocks Found

| ID | Locations | Lines | Similarity | Recommendation |
|----|-----------|-------|------------|----------------|
| DUP1 | website/slideshow.js ‚Üî website/runtime/catalog/slideshow.js | 575 | 100% | Eliminate one copy; reference single canonical location |
| DUP2 | website/admin/gallery/dropzone.js ‚Üî website/MineralCollection/gallery/dropzone.js | 1,621 | 100% | Eliminate one copy; use shared `/scripts/` or CDN reference |
| DUP3 | website/sites/ProjectMechanics/search/searchfield.js ‚Üî website/sites/WebProjectMechanics/search/searchfield.js | 184 | 100% | Consolidate to shared file |
| DUP4 | website/runtime/search/searchfield.js ‚Üî above two copies | 184 | ~98% | Differs only in `defaultText` config value; parameterize |
| DUP5 | 3√ó swfobject.js (different versions) | Various | N/A | All obsolete (Flash dead) ‚Äî remove all together with Flash content |

### Duplicate Impact

| Metric | Value |
|--------|-------|
| Total Duplicate Lines | ~2,564 |
| % of Total JS Code | ~7.9% |
| Affected Files | 9 |

## Recommendations

### Immediate Actions (CRITICAL)

1. **SEC1-SEC3**: Refactor `UtilityDB.vb` data access methods to require parameterized queries. Eliminate all `String.Format` / string concatenation patterns in SQL construction across `Article.vb`, `ArticleList.vb`, `LocationBuildHTML.vb`, `SiteTemplate.vb`, `Part.vb`, and `PartDirectory.vb`. Use the existing `wpm_AddParameterStringValue` / `wpm_AddParameterValue` helpers consistently.
2. **TEST0**: Establish a test project and begin adding unit tests for critical data access and domain logic.
3. **DUP1-DUP2**: Remove identical duplicate JavaScript files (slideshow.js, dropzone.js) to reduce maintenance risk.

### High Priority (This Sprint)

1. **DOC1**: Add `<DocumentationFile>` to RssToolkit.csproj in both Debug and Release configurations.
2. **QUAL2-QUAL3**: Remove obsolete Flash-era directories (`runtime/youtube/`, `sites/ProjectMechanics/facebook/`).
3. **INTF1-INTF5**: Create interface contracts for core RssToolkit public classes (`IRssDocument`, `IRssItem`, `IRssChannel`, `IDownloadManager`, `IRssAggregator`).
4. **SEC4-SEC7**: Convert remaining string-formatted SQL queries to parameterized versions.
5. **SEC11**: Evaluate upgrading `requestValidationMode` from `"2.0"` to `"4.5"`.

### Medium Priority (Next Sprint)

1. **ORG1**: Move interface files from centralized `WebProjectMechanics/Interfaces/` into their respective feature directories.
2. **DOC2-DOC3**: Add XML documentation to RemoveWWW public members.
3. **QUAL1**: Consider splitting `CsvReader.cs` (2,059 lines) into smaller focused classes.
4. **QUAL5**: Clean up dead website files (`test.aspx`, error demo pages).
5. **DUP3-DUP4**: Consolidate `searchfield.js` copies with parameterizable config.

### Low Priority (Backlog)

1. **ORG2-ORG3**: Refactor `Utility/` catch-all directory; move `SiteTemplate.vb` into a feature folder.
2. **DOC4**: Remove `NOWARN>1591` from RemoveWWW.csproj to surface missing XML doc warnings.
3. **INTF6**: Create interfaces for remaining RssToolkit public classes (OpmlDocument, etc.).
4. **QUAL4**: Audit ImageResizer usage ‚Äî either recommit to usage or remove the package.
5. **DUP5**: Remove all obsolete swfobject.js copies.
6. Add `<DocumentationFile>` to LumenWorks Debug configuration (currently Release-only).

## Next Steps

1. Address all CRITICAL SQL injection issues before next deployment
2. Establish a test project to begin building coverage
3. Remove dead Flash-era code to reduce attack surface and repository size
4. Schedule HIGH priority items for current sprint
5. Add MEDIUM items to backlog
6. Re-run audit weekly to track progress

---

*Audit generated by speckit.site-audit v1.0*
*Constitution-driven codebase audit for WebProjectMechanics*
*Next audit recommended: 2026-02-23*
*To re-run: `/speckit.site-audit` or `/speckit.site-audit --scope=constitution`*
